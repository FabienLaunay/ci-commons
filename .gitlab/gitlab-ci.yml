stages:
  - lint
  - build

Lint-ci-commons-project:
  stage: lint
  rules:
    # Trigger on push to main branch
    - if: '$CI_PROJECT_NAME == "ci-commons" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
  # Trigger on merge request to main branch
    - if: '$CI_PROJECT_NAME == "ci-commons" && $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
  image:
    name: python:3.9-slim
    entrypoint: [""]
  before_script:
    - bash bsh/lintCiCommonsProjectBeforeScript.bash
  script:
    # Fetch all commits and branches
    - git fetch --all
    # Find the common ancestor between the branch and main
    - MERGE_BASE=$(git merge-base HEAD origin/main)
    # Lint all commits between the feature branch and the main branch
    - |
      gitlint \
        --config cfg/gitlint/gitlint.cfg \
        --commits $MERGE_BASE..HEAD

Lint:
  stage: lint
  rules:
    # Trigger on push to main branch
    - if: '$CI_PROJECT_NAME != "ci-commons" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
    # Trigger on merge request to main branch
    - if: '$CI_PROJECT_NAME != "ci-commons" && $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'

  image:
    name: python:3.9-slim
    entrypoint: [""]
  before_script:
    - apt-get update
    - apt-get install -y curl unzip git
    - pip install gitlint
    - |
      if [ ! -f cfg/gitlint/gitlint.cfg ]; then
        echo "Downloading artifacts.zip from 'ci-commons' project..."        
        curl \
          --location \
          --header "PRIVATE-TOKEN: $CI_PERSONAL_ACCESS_TOKEN" \
          --output artifacts.zip \
          "https://gitlab.com/api/v4/projects/56935262/jobs/artifacts/main/download?job=Generate-artifacts"
        unzip artifacts.zip
      fi
  script:
    # Fetch all commits and branches
    - git fetch --all
    # Find the common ancestor between the branch and main
    - MERGE_BASE=$(git merge-base HEAD origin/main)
    # Lint all commits between the feature branch and the main branch
    - |
      gitlint \
        --config cfg/gitlint/gitlint.cfg \
        --commits $MERGE_BASE..HEAD

Generate-artifacts:
  stage: build
  rules:
    # Trigger on push to main branch
    - if: '$CI_PROJECT_NAME == "ci-commons" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
    # Trigger on merge request to main branch
    - if: '$CI_PROJECT_NAME == "ci-commons" && $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
  script:
    - echo "Generating artifacts..."
  artifacts:
    paths:
      - cfg/gitlint/


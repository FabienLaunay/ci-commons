stages:
  - lint
  - build

Lint-Git-Commit-Messages-For-ci-commons-Project:
  stage: lint
  rules:
    # Trigger on push to main branch
    - if: >
        $CI_PROJECT_NAME == "ci-commons" &&
        $CI_PIPELINE_SOURCE == "push" &&
        $CI_COMMIT_BRANCH == "main"
  # Trigger on merge request to main branch
    - if: >
        $CI_PROJECT_NAME == "ci-commons" &&
        $CI_PIPELINE_SOURCE == "merge_request_event" &&
        $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
  image:
    name: python:3.9-slim
    entrypoint: [""]
  before_script:
    - |
      # [IN ] Collapse before script commands
      echo -e "\e[0Ksection_start:`date +%s`:before_script_section[collapsed=true]\r\e[0KBefore script commands"
    - apt-get update
    - bash bsh/lintCiCommonsProjectBeforeScript.bash "git"
    - |
      # [OUT] Collapse before script commands 
      echo -e "\e[0Ksection_end:`date +%s`:before_script_section\r\e[0K"
  script:
    - |
      # [IN ] Collapse before script commands
      echo -e "\e[0Ksection_start:`date +%s`:script_section[collapsed=true]\r\e[0KScript commands"
    - |
      if [[ "$CI_COMMIT_BRANCH" == "main" ]]; then
        bash bsh/lintCiCommonsProjectScript.bash \
          "$CI_COMMIT_BEFORE_SHA" \
          "$CI_COMMIT_SHA" 
      elif [[ "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" == "main" ]]; then
        bash bsh/lintCiCommonsProjectScript.bash \
          "$CI_MERGE_REQUEST_DIFF_BASE_SHA" \
          "$CI_COMMIT_SHA"        
      fi
    - |
      # [IN ] Collapse before script commands
      echo -e "\e[0Ksection_end:`date +%s`:script_section\r\e[0K"

Lint-Git-Commit-Messages:
  stage: lint
  rules:
    - if: >
        $CI_PROJECT_NAME != "ci-commons" &&
        $CI_PIPELINE_SOURCE == "merge_request_event" &&
        $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"

  image:
    name: python:3.9-slim
    entrypoint: [""]
  before_script:
     - apt-get update
     - apt-get install --yes curl
     - |
       # Download Artifacts from 'ci-commons' project
       curl \
         --location \
         --header "PRIVATE-TOKEN: $CI_PERSONAL_ACCESS_TOKEN" \
         --output artifacts.zip \
         "https://gitlab.com/api/v4/projects/56935262/jobs/artifacts/main/\
       download?job=Generate-Artifacts"
     - apt-get install --yes unzip
     - unzip artifacts.zip
     - bash bsh/lintCiCommonsProjectBeforeScript.bash "git"
  script:
      bash bsh/lintCiCommonsProjectScript.bash \
        "$CI_MERGE_REQUEST_DIFF_BASE_SHA" \
        "$CI_COMMIT_SHA"

Generate-Artifacts:
  stage: build
  rules:
    # Trigger on push to main branch
    - if: >
        $CI_PROJECT_NAME == "ci-commons" &&
        $CI_PIPELINE_SOURCE == "push" &&
        $CI_COMMIT_BRANCH == "main"
    # Trigger on merge request to main branch
    - if: >
        $CI_PROJECT_NAME == "ci-commons" &&
        $CI_PIPELINE_SOURCE == "merge_request_event" &&
        $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
  script:
    - echo "Generating artifacts..."
  artifacts:
    paths:
      - bsh/
      - cfg/